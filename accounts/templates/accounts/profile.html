{% extends "accounts/base.html" %}

{% block content %}
    <h2>{{ user.username }}ë‹˜ì˜ í”„ë¡œí•„</h2>
    <p>í™˜ì˜í•©ë‹ˆë‹¤, {{ user.username }}ë‹˜!</p>

    <br>

    <h3>ğŸ“„ ë‚´ê°€ ì‘ì„±í•œ ë§í¬</h3>
    <ul>
        {% for link in my_created_links %}
            <li>
                <a href="{{ link.url }}" target="_blank">{{ link.name }}</a>
                <button class="copy-btn btn btn-secondary btn-sm" data-url="{{ link.url }}">ğŸ“‹ ë³µì‚¬</button>
                <button class="share-btn btn btn-primary btn-sm" data-id="{{ link.id }}">ğŸ”— ê³µìœ </button> <!-- âœ… ê³µìœ  ë²„íŠ¼ ì¶”ê°€ -->
            </li>
        {% empty %}
            <p>ì‘ì„±í•œ ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endfor %}
    </ul>

    <br>


    <h3>ğŸ“¤ ë‚´ê°€ ê³µìœ í•œ ë§í¬</h3>
    <ul>
        {% for link in my_shared_links %}
            <li>
                <a href="{{ link.url }}" target="_blank">{{ link.name }}</a>
                (ğŸ‘¥ ê³µìœ  ëŒ€ìƒ:
                    {% for user in link.shared_with.all %}
                        {{ user.username }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                )
                <button class="share-btn btn btn-primary btn-sm" data-id="{{ link.id }}">ğŸ”— ê³µìœ </button>
            </li>
        {% empty %}
            <p>ê³µìœ í•œ ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endfor %}
    </ul>



    <br>

    <h3>ğŸ“¥ ë‚´ê°€ ê³µìœ ë°›ì€ ë§í¬</h3>
    <ul>
        {% for link in received_links %}
            <li>
                <a href="{{ link.url }}" target="_blank">{{ link.name }}</a>
                (ğŸ“ ê³µìœ í•œ ì‚¬ëŒ: {{ link.created_by.username }})
                <button class="edit-btn btn btn-warning btn-sm" data-id="{{ link.id }}" data-name="{{ link.name }}" data-url="{{ link.url }}">âœï¸ ìˆ˜ì •</button>
            </li>
        {% empty %}
            <p>ê³µìœ ë°›ì€ ë§í¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endfor %}
    </ul>

    <br>

    <div class="modal fade" id="shareModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ”— ë§í¬ ê³µìœ </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label for="userSelect">ì‚¬ìš©ì ì„ íƒ:</label>
                    <select id="userSelect" class="form-control" multiple></select>
                    <br>
                    <label><input type="checkbox" id="writePermission"> âœï¸ ì“°ê¸° ê¶Œí•œ ë¶€ì—¬</label>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    <button type="button" class="btn btn-primary" id="confirmShare">ê³µìœ </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">âœï¸ ë§í¬ ìˆ˜ì •</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <label for="editLinkName">ì´ë¦„:</label>
                    <input type="text" id="editLinkName" class="form-control">

                    <label for="editLinkUrl" class="mt-2">URL:</label>
                    <input type="text" id="editLinkUrl" class="form-control">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                    <button type="button" class="btn btn-success" id="confirmEdit">ìˆ˜ì •</button>
                </div>
            </div>
        </div>
    </div>

    <script>
document.addEventListener("DOMContentLoaded", function() {
    const API_TOKEN = document.querySelector("meta[name='api-token']").content;
    const csrftoken = document.querySelector("meta[name='csrf-token']").content;
    const userSelect = document.getElementById("userSelect");
    let editingLinkId = null;

    document.querySelectorAll(".copy-btn").forEach(button => {
        button.addEventListener("click", function() {
            const linkUrl = this.getAttribute("data-url");
            navigator.clipboard.writeText(linkUrl).then(() => {
                alert("ğŸ“‹ ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
            }).catch(err => {
                console.error("í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:", err);
            });
        });
    });

    document.querySelectorAll(".share-btn").forEach(button => {
        button.addEventListener("click", function() {
            const linkId = this.getAttribute("data-id");
            document.getElementById("confirmShare").setAttribute("data-id", linkId);
            fetchUsers();
            const shareModal = new bootstrap.Modal(document.getElementById("shareModal"));
            shareModal.show();
        });
    });

    function fetchUsers() {
        fetch("/accounts/users/", {
            headers: { "Authorization": `Token ${API_TOKEN}` }
        })
        .then(response => response.json())
        .then(data => {
            userSelect.innerHTML = "";
            data.users.forEach(user => {
                const option = document.createElement("option");
                option.value = user.id;
                option.textContent = user.username;
                userSelect.appendChild(option);
            });
        })
        .catch(error => console.error("ì‚¬ìš©ì ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error));
    }

    document.getElementById("confirmShare").addEventListener("click", function() {
        const linkId = this.getAttribute("data-id");
        const selectedUsers = Array.from(userSelect.selectedOptions).map(option => option.value);
        const writePermission = document.getElementById("writePermission").checked;

        fetch(`/weblinks/weblinks/${linkId}/share/`, {
            method: "POST",
            headers: {
                "Authorization": `Token ${API_TOKEN}`,
                "X-CSRFToken": csrftoken,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ users: selectedUsers, write: writePermission })
        })
        .then(response => response.json())
        .then(data => {
            alert("âœ… ê³µìœ  ì„±ê³µ: " + data.shared_users.join(", "));
            location.reload();
        })
        .catch(error => {
            console.error("ê³µìœ  ì‹¤íŒ¨:", error);
            alert("âš ï¸ ê³µìœ  ì‹¤íŒ¨: " + error.message);
        });
    });


function editWebLink(id, name, url) {
    editingLinkId = id;
    document.getElementById("editLinkName").value = name;
    document.getElementById("editLinkUrl").value = url;

    const editModal = new bootstrap.Modal(document.getElementById("editModal"));
    editModal.show();
}

document.querySelectorAll(".edit-btn").forEach(button => {
    button.addEventListener("click", function() {
        const id = this.getAttribute("data-id");
        const name = this.getAttribute("data-name");
        const url = this.getAttribute("data-url");

        editWebLink(id, name, url);
    });
});


    document.querySelectorAll(".edit-btn").forEach(button => {
        button.addEventListener("click", function() {
            editingLinkId = this.getAttribute("data-id");
            document.getElementById("editLinkName").value = this.getAttribute("data-name");
            document.getElementById("editLinkUrl").value = this.getAttribute("data-url");

            new bootstrap.Modal(document.getElementById("editModal")).show();
        });
    });

    document.getElementById("confirmEdit").addEventListener("click", function() {
        const newName = document.getElementById("editLinkName").value;
        const newUrl = document.getElementById("editLinkUrl").value;

        fetch(`/weblinks/weblinks/${editingLinkId}/`, {
            method: "PATCH",
            headers: {
                "Authorization": `Token ${API_TOKEN}`,
                "X-CSRFToken": csrftoken,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ name: newName, url: newUrl })
        })
        .then(data => {
            alert("âœ… ìˆ˜ì • ì„±ê³µ!");
            console.log("ğŸ”„ ìˆ˜ì • ì™„ë£Œ:", data);
            location.reload();
        })
        .catch(error => alert("âš ï¸ ìˆ˜ì • ì‹¤íŒ¨: " + error.message));
    });
});
</script>

{% endblock %}
